generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Karyawan {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customId        String     @unique
  name            String
  nip             String?    @unique
  nik             String?    @unique
  npwp            String?    @unique
  emailPribadi    String?
  phone           String?
  address         String?
  birthDate       String?
  tempatLahir     String?
  jenisKelamin    String?
  agama           String?
  joinDate        String
  position        String
  department      String
  pendidikan      String?
  golongan        String?
  image           String?
  kontakDarurat   String?
  hubunganDarurat String?
  status          UserStatus
  lastLogin       DateTime?
  user            User?

  surat_tugas_anggota SuratTugasAnggota[]

  @@map("karyawan")
}

model User {
  id           String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customId     String              @unique
  username     String              @unique
  email        String              @unique
  role         Role
  status         UserStatus       @default(AKTIF)
  passwordHash String
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  kantorId     String?             @db.Uuid
  izinLokasi   AbsensiIzinLokasi[]
  attendances  Attendance[]
  barcodes     Barcode[]
  karyawan     Karyawan            @relation(fields: [customId], references: [customId])
  kantor       Kantor?             @relation("KantorUsers", fields: [kantorId], references: [id])
  
  kantorTetap  Boolean     @default(false)

  surat_tugas_dibuat     SuratTugas[] @relation("PembuatSurat")
  surat_tugas_disetujui_admin SuratTugas[] @relation("ApprovalAdmin")
  surat_tugas_disetujui_owner SuratTugas[] @relation("ApprovalOwner")
  suratKeluarAlat  SuratKeluarAlat[] @relation("UserPembuat")

  @@map("users")
}

model Attendance {
  id_at        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String
  kantorId     String?          @db.Uuid
  lokasiId     String?          @db.Uuid
  date         DateTime
  clockIn      String?
  clockOut     String?
  statusMasuk   AttendanceMasuk
  statusPulang  AttendancePulang?
  photoIn      String?
  photoOut     String?
  latitude     Float?
  longitude    Float?
  location     String?
  barcodeIn    String?
  barcodeOut   String?
  barcodeInAt  DateTime?
  barcodeOutAt DateTime?
  createdAt    DateTime         @default(now())
  user         User             @relation(fields: [userId], references: [customId])
  kantor       Kantor?          @relation(fields: [kantorId], references: [id])
  lokasiDinas  LokasiDinas?     @relation(fields: [lokasiId], references: [id])
  keterangan   Keterangan
}

model Barcode {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [customId])
}

model AlatKalibrasi {
  id                 String   @id @default(uuid()) @db.Uuid
  nama_alat          String
  wilayahKerja       wilayahKerja[]
}

model SparePart {
  id                  String      @id @default(uuid()) @db.Uuid
  nama                String
  kode                String?      @unique
  jumlah              Int
  lokasi              String?
  supplier            String?
  foto                String?
  status              String
  created_at          DateTime    @default(now()) @db.Timestamptz(0)
  updated_at          DateTime    @updatedAt @db.Timestamptz(0)
  
  // Relations
  AlatKalibrator       AlatSparepart[]
  
  @@map("SparePart")
}

model LokasiDinas {
  id        String              @id @default(uuid()) @db.Uuid
  name      String
  latitude  Float
  longitude Float
  Lokasi    String
  SK String
  satuanKerja   SatuanKerja?   @relation(fields: [SK], references: [kodeSK])
  radius    Int                 @default(30)
  wilayahId Int?
  wilayah   Wilayah? @relation(fields: [wilayahId], references: [id])
  telp      String?
  jamBuka   String?           @map("jambuka")

  izinList  AbsensiIzinLokasi[]
  wilayahKerja wilayahKerja[]
  surat_tugas_lokasi SuratTugasLokasi[]
  attendances Attendance[]
}

model Wilayah {
  id           Int      @id @default(autoincrement())
  nama_wilayah String
  longitude    Float?
  latitude     Float?
  Deskripsi    String?

  lokasiList   LokasiDinas[]

  @@map("wilayah") 
}

model AbsensiIzinLokasi {
  id              Int      @id @default(autoincrement())
  userId          String
  lokasiId        String      @db.Uuid
  kantorId        String?     @db.Uuid
  tanggalMulai    DateTime
  tanggalSelesai  DateTime
  keperluan       String?
  createdAt DateTime    @default(now())
  kantor    Kantor?     @relation(fields: [kantorId], references: [id])
  lokasi    LokasiDinas? @relation(fields: [lokasiId], references: [id])
  user      User        @relation(fields: [userId], references: [customId])
}

model Kantor {
  id          String              @id @default(uuid()) @db.Uuid
  kodeKantor  String              @unique
  nama        String
  alamat      String?
  latitude    Float
  longitude   Float
  radiusMeter Float
  createdAt   DateTime            @default(now())
  izinLokasi  AbsensiIzinLokasi[]
  attendances  Attendance[]
  users       User[]              @relation("KantorUsers")
}

model SatuanKerja {
  id          String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  kodeSK      String              @unique
  NamaSK      String 
  Lokasi      LokasiDinas[]
}

model wilayahKerja {
  id          String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  unit        Int
  id_LK      String       @db.Uuid
  id_AK        String     @db.Uuid

  alatKalibrasi AlatKalibrasi @relation(fields: [id_AK], references: [id])
  lokasiDinas   LokasiDinas   @relation(fields: [id_LK], references: [id])
}

model AlatKalibrator {
  id                  String      @id @default(uuid()) @db.Uuid
  kode_barcode        String?     @unique
  nama_alat           String
  jumlah              Int?
  tahun_pembelian     Int?
  merk                String?
  type                String?
  fungsi_kalibrasi    String?
  status_vendor       String?
  kalibrasi_terakhir  DateTime?
  created_at          DateTime    @default(now()) @db.Timestamptz(0)
  updated_at          DateTime    @updatedAt @db.Timestamptz(0)
  
  // Relations
  kalibrasi           Kalibrasi[]
  aksesoris           AlatSparepart[]
  units               AlatKalibratorUnit[]
  @@map("AlatKalibrator")
}

model Vendor {
  id                  String      @id @default(uuid()) @db.Uuid
  nama_vendor         String
  kontak              String?
  created_at          DateTime    @default(now()) @db.Timestamptz(0)
  updated_at          DateTime    @updatedAt @db.Timestamptz(0)
  
  // Relations
  kalibrasi           Kalibrasi[]
  
  @@map("vendor")
}

model Kalibrasi {
  id                  String      @id @default(uuid()) @db.Uuid
  tanggal_kalibrasi   DateTime
  tanggal_expired     DateTime
  created_at          DateTime    @default(now()) @db.Timestamptz(0)
  updated_at          DateTime    @updatedAt @db.Timestamptz(0)
  
  // Foreign keys
  alat_id             String      @db.Uuid
  vendor_id           String      @db.Uuid
  
  // Relations
  AlatKalibrator      AlatKalibrator        @relation(fields: [alat_id], references: [id], onDelete: Cascade)
  vendor              Vendor      @relation(fields: [vendor_id], references: [id], onDelete: Cascade)
  
  @@map("kalibrasi")
}

model AlatSparepart {
  id                  String      @id @default(uuid()) @db.Uuid
  jumlah              Int
  keterangan          String?
  created_at          DateTime    @default(now()) @db.Timestamptz(0)
  updated_at          DateTime    @updatedAt @db.Timestamptz(0)
  
  // Foreign keys
  alat_id             String      @db.Uuid
  sparepart_id        String      @db.Uuid
  
  // Relations
  AlatKalibrator      AlatKalibrator        @relation(fields: [alat_id], references: [id], onDelete: Cascade)
  SparePart           SparePart             @relation(fields: [sparepart_id], references: [id], onDelete: Cascade)
  
  @@map("alat_sparepart")
}

model AlatKalibratorUnit {
  id        String   @id @default(uuid()) @db.Uuid
  alat_id   String   @db.Uuid
  kondisi   String   @default("Baik")
  kode_unit String?  @unique
  status    StatusAlat @default(TERSEDIA)
  nomor_seri String?
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  AlatKalibrator AlatKalibrator @relation(fields: [alat_id], references: [id], onDelete: Cascade)
  suratItems      SuratKeluarAlatItem[]
  
  @@map("AlatKalibratorUnit")
}

model SuratTugas {
  id                     String           @id @default(uuid()) @db.Uuid
  nomor_surat            String           @unique
  judul_tugas            String
  tanggal_mulai          DateTime         @db.Timestamptz(0)
  tanggal_selesai        DateTime         @db.Timestamptz(0)
  keterangan             String?
  status                 StatusSuratTugas @default(DRAFT)
  file_surat             String?
  tanggal_berangkat      DateTime?        @db.Timestamptz(0)
  jam_berangkat          String?
  akomodasi              String?
  wilayah                String?
  kendaraan              String?
  pembuat_surat_id       String
  pembuat_surat          User            @relation("PembuatSurat", fields: [pembuat_surat_id], references: [customId], onDelete: Restrict)

  approved_by_admin_id   String?
  approved_by_admin      User?           @relation("ApprovalAdmin", fields: [approved_by_admin_id], references: [customId], onDelete: SetNull)

  approved_by_owner_id   String?
  approved_by_owner      User?           @relation("ApprovalOwner", fields: [approved_by_owner_id], references: [customId], onDelete: SetNull)

  approved_at_admin      DateTime?        @db.Timestamptz(0)
  approved_at_owner      DateTime?        @db.Timestamptz(0)

  approval_status_admin  ApprovalStatus   @default(PENDING)
  approval_status_owner  ApprovalStatus   @default(PENDING)

  created_at             DateTime         @default(now()) @db.Timestamptz(0)
  updated_at             DateTime         @default(now()) @db.Timestamptz(0)

  // Relasi ke anggota dan lokasi
  anggotaSurat            SuratTugasAnggota[]
  lokasiSurat             SuratTugasLokasi[]

  @@map("surat_tugas")
}

model SuratTugasAnggota {
  id              String      @id @default(uuid()) @db.Uuid
  nomor_surat     String
  surat_tugas     SuratTugas  @relation(fields: [nomor_surat], references: [nomor_surat], onDelete: Cascade)
  karyawan_id     String
  karyawan        Karyawan    @relation(fields: [karyawan_id], references: [customId], onDelete: Cascade)
  peran           String?
  created_at      DateTime    @default(now()) @db.Timestamptz(0)

  @@unique([nomor_surat, karyawan_id])
  @@map("surat_tugas_anggota")
}

model SuratTugasLokasi {
  id              String      @id @default(uuid()) @db.Uuid
  nomor_surat     String
  surat_tugas     SuratTugas  @relation(fields: [nomor_surat], references: [nomor_surat], onDelete: Cascade)
  lokasi_id       String
  lokasi          LokasiDinas @relation(fields: [lokasi_id], references: [id], onDelete: Cascade)
  created_at      DateTime    @default(now()) @db.Timestamptz(0)

  @@unique([nomor_surat, lokasi_id])
  @@map("surat_tugas_lokasi")
}

model SuratKeluarAlat {
  id              String            @id @default(cuid())
  nomor_surat     String            @unique
  tanggal         DateTime
  keperluan       String
  statusManajer   ApprovalStatus    @default(PENDING)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  pembuatId       String
  pembuat         User              @relation("UserPembuat", fields: [pembuatId], references: [customId])

  // Relasi ke daftar barang
  daftarAlat      SuratKeluarAlatItem[]

  @@map("surat_keluar_alat")
}

model SuratKeluarAlatItem {
  id               String            @id @default(cuid())
  nomor_surat      String   
  unitId           String
  accessories      String
  kondisiKabel  KondisiAlat? 
  kondisiTombol KondisiAlat? 
  kondisiFungsi KondisiAlat? 
  kondisiFisik  KondisiAlat? 

  surat           SuratKeluarAlat    @relation(fields: [nomor_surat], references: [nomor_surat])
  unit            AlatKalibratorUnit @relation( fields: [unitId], references: [kode_unit])

  @@map("item_surat_alat")
}

enum Role {
  ADMIN
  OWNER
  DIREKTUR
  MANAJER
  KARYAWAN
  TEKNISI
  KEUANGAN
  KEPALA_GUDANG
}

enum UserStatus {
  AKTIF
  NONAKTIF
  DITANGGUHKAN
}

enum AttendanceMasuk {
  TEPAT_WAKTU
  TERLAMBAT
  TIDAK_HADIR
}

enum AttendancePulang {
  TEPAT_WAKTU
  PULANG_CEPAT
  TIDAK_HADIR
}

enum Keterangan {
  HADIR
  IZIN
  SAKIT
  ALPHA
}

enum StatusSuratTugas {
  DRAFT
  MENUNGGU_APPROVAL
  DISETUJUI
  DITOLAK
  SELESAI
}

enum ApprovalStatus {
  PENDING
  DISETUJUI
  DITOLAK
}

enum KondisiAlat {
  BAIK
  RUSAK
  KURANG
  BELUM_DICEK
}

enum StatusAlat {
  DIGUNAKAN
  TERSEDIA
  DIKALIBRASI
}